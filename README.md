# Avatar

> A lightweight and high-performance Hypervisor and Kernel for ARM64 (AArch64) platforms.

**Avatar** æ˜¯ä¸€ä¸ªé¢å‘ ARM64 æ¶æ„çš„è½»é‡çº§è™šæ‹ŸåŒ–ç®¡ç†ç¨‹åº (Hypervisor) ä»¥åŠè‡ªä¸»å†…æ ¸ï¼Œå®ç°äº†å¤šè™šæ‹Ÿæœºï¼ˆVMï¼‰å¹¶å‘è¿è¡Œï¼Œæ”¯æŒå¤šæ ¸ SMPã€‚é¡¹ç›®å…¼é¡¾è£¸æœºæ€§èƒ½å’Œè™šæ‹ŸåŒ–çµæ´»æ€§ï¼Œé€‚åˆåµŒå…¥å¼å’Œäº‘è®¡ç®—åœºæ™¯ã€‚

---

## ğŸš€ VMM (Virtual Machine Monitor)

Avatar VMM æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„è™šæ‹ŸåŒ–ç®¡ç†ç¨‹åºï¼Œè¿è¡Œåœ¨ ARM64 EL2 ç‰¹æƒçº§åˆ«ï¼Œæä¾›å®Œæ•´çš„è™šæ‹ŸåŒ–æ”¯æŒã€‚

### æ ¸å¿ƒç‰¹æ€§

- **å¤šè™šæ‹Ÿæœºç®¡ç†**ï¼šæ”¯æŒåŒæ—¶è¿è¡Œå¤šä¸ª Guest æ“ä½œç³»ç»Ÿ
- **åŠ¨æ€ Guest åŠ è½½**ï¼šä»æ–‡ä»¶ç³»ç»ŸåŠ¨æ€åŠ è½½ VM é•œåƒï¼Œæ— éœ€é‡æ–°ç¼–è¯‘
- **å¤šæ ¸ SMP æ”¯æŒ**ï¼šæ”¯æŒå¤šè™šæ‹Ÿ CPU è°ƒåº¦å’Œè´Ÿè½½å‡è¡¡
- **å¼‚å¸¸è™šæ‹ŸåŒ–**ï¼šå®Œæ•´çš„ EL2 å¼‚å¸¸å‘é‡å’Œä¸­æ–­å¤„ç†
- **å†…å­˜è™šæ‹ŸåŒ–**ï¼šStage-2 åœ°å€ç¿»è¯‘å’Œå†…å­˜éš”ç¦»
- **è®¾å¤‡è™šæ‹ŸåŒ–**ï¼šè™šæ‹Ÿè®¾å¤‡å’Œè®¾å¤‡é€ä¼ æ”¯æŒ

### VMM æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Avatar VMM (EL2)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Guest Management  â”‚  Resource Manager  â”‚
â”‚  â€¢ Guest Loader    â”‚  â€¢ Memory Manager  â”‚
â”‚  â€¢ vCPU Scheduler  â”‚  â€¢ Interrupt Ctrl  â”‚
â”‚  â€¢ Guest Monitor   â”‚  â€¢ Device Manager  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚            File System Layer            â”‚
â”‚  â€¢ FAT32 Support  â”‚  â€¢ Guest Manifests â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚               Hardware (EL1)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ”¯æŒçš„ Guest ç±»å‹

- **Linux Guest**: å®Œæ•´çš„ Linux å†…æ ¸ï¼Œæ”¯æŒè®¾å¤‡æ ‘å’Œ initrd
- **NimbOS Guest**: Rust ç¼–å†™çš„å®æ—¶æ“ä½œç³»ç»Ÿ
- **TestOS Guest**: ç®€å•çš„æµ‹è¯•æ“ä½œç³»ç»Ÿ

### Guest é…ç½®ç³»ç»Ÿ

- **åŸºäº Manifest**: é€šè¿‡ `guest/guest_manifests.c` é…ç½® Guest å‚æ•°
- **çµæ´»é…ç½®**: æ”¯æŒåŠ è½½åœ°å€ã€SMP æ ¸å¿ƒæ•°ã€ä¾èµ–æ–‡ä»¶ç­‰é…ç½®
- **è¿è¡Œæ—¶ç®¡ç†**: æ”¯æŒ Guest çš„å¯åŠ¨ã€åœæ­¢ã€ç›‘æ§ç­‰æ“ä½œ

---

## ğŸ”§ Kernel

Avatar Kernel æ˜¯ä¸€ä¸ªè‡ªä¸»è®¾è®¡çš„å¾®å†…æ ¸ï¼Œæä¾›åŸºç¡€çš„æ“ä½œç³»ç»ŸæœåŠ¡å’Œç³»ç»Ÿè°ƒç”¨æ¥å£ã€‚

### æ ¸å¿ƒç‰¹æ€§

- **ä»»åŠ¡è°ƒåº¦**ï¼šæŠ¢å å¼å¤šä»»åŠ¡è°ƒåº¦å™¨ï¼Œæ”¯æŒä¼˜å…ˆçº§è°ƒåº¦
- **å†…å­˜ç®¡ç†**ï¼šé¡µå¼å†…å­˜ç®¡ç†ï¼Œæ”¯æŒè™šæ‹Ÿå†…å­˜å’Œç‰©ç†å†…å­˜åˆ†é…
- **åŒæ­¥åŸè¯­**ï¼šäº’æ–¥é”ã€ä¿¡å·é‡ã€æ¡ä»¶å˜é‡ç­‰åŒæ­¥æœºåˆ¶
- **ä¸­æ–­å¤„ç†**ï¼šå®Œæ•´çš„ä¸­æ–­æ§åˆ¶å™¨æ”¯æŒå’Œä¸­æ–­å¤„ç†æ¡†æ¶
- **ç³»ç»Ÿè°ƒç”¨**ï¼šæ ‡å‡†çš„ç³»ç»Ÿè°ƒç”¨æ¥å£å’Œç”¨æˆ·æ€æ”¯æŒ
- **æ–‡ä»¶ç³»ç»Ÿ**ï¼šFAT32 æ–‡ä»¶ç³»ç»Ÿå®ç°ï¼Œæ”¯æŒæ–‡ä»¶å’Œç›®å½•æ“ä½œ

### Kernel æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Application Layer             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚            System Call API             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              Avatar Kernel              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Scheduler â”‚    Memory Manager   â”‚  â”‚
â”‚  â”‚   â€¢ Tasks   â”‚    â€¢ Page Alloc    â”‚  â”‚
â”‚  â”‚   â€¢ SMP     â”‚    â€¢ Virtual Mem   â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ Sync Prims  â”‚    File System     â”‚  â”‚
â”‚  â”‚ â€¢ Mutex     â”‚    â€¢ FAT32         â”‚  â”‚
â”‚  â”‚ â€¢ Semaphore â”‚    â€¢ VFS           â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ Interrupt   â”‚    Device Drivers   â”‚  â”‚
â”‚  â”‚ â€¢ GIC       â”‚    â€¢ UART          â”‚  â”‚
â”‚  â”‚ â€¢ Timer     â”‚    â€¢ Storage       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              Hardware (EL1)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å†…æ ¸æ¨¡å—

- **è°ƒåº¦å™¨**: æ”¯æŒå¤šæ ¸ SMP å’Œä¼˜å…ˆçº§è°ƒåº¦
- **å†…å­˜ç®¡ç†**: é¡µå¼å†…å­˜ç®¡ç†å’Œå†…å­˜æ± åˆ†é…
- **æ–‡ä»¶ç³»ç»Ÿ**: å®Œæ•´çš„ FAT32 å®ç°
- **è®¾å¤‡é©±åŠ¨**: UARTã€å­˜å‚¨è®¾å¤‡ç­‰åŸºç¡€é©±åŠ¨
- **åŒæ­¥æœºåˆ¶**: å®Œæ•´çš„åŒæ­¥åŸè¯­å®ç°

---


## ğŸ› ï¸ æ„å»ºå’Œè¿è¡Œ

### ç¯å¢ƒè¦æ±‚

- **å·¥å…·é“¾**: AArch64 äº¤å‰ç¼–è¯‘å·¥å…·é“¾
- **æ¨¡æ‹Ÿå™¨**: QEMU (æ”¯æŒ ARM64 è™šæ‹ŸåŒ–)
- **ç³»ç»Ÿ**: Linux å¼€å‘ç¯å¢ƒ
- **æƒé™**: sudo æƒé™ï¼ˆç”¨äºæ–‡ä»¶ç³»ç»Ÿæ“ä½œï¼‰

### å¿«é€Ÿå¼€å§‹

#### 1. å…‹éš†é¡¹ç›®
```bash
git clone https://github.com/pengzechen/Avatar.git
cd Avatar
git submodule update --init --recursive

# æˆ–è€…ä¸€æ¬¡æ€§å…‹éš†
git clone --recurse-submodules https://github.com/pengzechen/Avatar.git
```

#### 2. æ„å»º Guest é•œåƒ
```bash
# æ„å»ºåº”ç”¨ç¨‹åº
make app

# æ„å»º TestOS Guest
cd guest/testos/
mkdir -p build
make SMP=1 GUEST_LABEL='[TestOS] ' LOAD_ADDR=0x60200000
cd ../../

# æ„å»º NimbOS Guest
cd guest/nimbos/kernel/
make build ARCH=aarch64
cd ../../../

# Linux Guest é•œåƒéœ€è¦å•ç‹¬å‡†å¤‡ï¼ˆå¯é€‰ï¼‰
# å°† linux.bin, linux.dtb, initrd.gz æ”¾ç½®åœ¨ guest/linux/ ç›®å½•ä¸‹
```

#### 3. è®¾ç½®æ–‡ä»¶ç³»ç»Ÿ
```bash
# åˆ›å»º host.img æ–‡ä»¶ç³»ç»Ÿé•œåƒ
./scripts/create_host_img.sh

# å°† Guest æ–‡ä»¶æ‹·è´åˆ°æ–‡ä»¶ç³»ç»Ÿä¸­
sudo ./scripts/setup_guest_files.sh

# æŸ¥çœ‹å¸®åŠ©ä¿¡æ¯
./scripts/setup_guest_files.sh -h
```

#### 4. ç¼–è¯‘å’Œè¿è¡Œ

**è¿è¡Œ VMM (è™šæ‹ŸåŒ–æ¨¡å¼)**
```bash
# ç¼–è¯‘ Avatar VMM
make clean && make

# è¿è¡Œè™šæ‹Ÿæœºç›‘æ§å™¨
make SMP=2 HV=1 run
```

**è¿è¡Œ Kernel (åŸç”Ÿæ¨¡å¼)**
```bash
# ç¼–è¯‘ Avatar Kernel
make clean && make

# è¿è¡Œå†…æ ¸
make SMP=2 run
```

### VMM ç®¡ç†å‘½ä»¤

åœ¨ Avatar VMM shell ä¸­å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç®¡ç† Guestï¼š

```bash
# Guest ç®¡ç†
guest list              # åˆ—å‡ºå¯ç”¨çš„ Guest
guest info <id>         # æ˜¾ç¤º Guest è¯¦ç»†ä¿¡æ¯
guest validate <id>     # éªŒè¯ Guest æ–‡ä»¶
guest start <id>        # å¯åŠ¨æŒ‡å®šçš„ Guest

# æ–‡ä»¶ç³»ç»Ÿæ“ä½œ
fs ls                   # åˆ—å‡ºæ–‡ä»¶ç³»ç»Ÿå†…å®¹
fs cat <file>           # æŸ¥çœ‹æ–‡ä»¶å†…å®¹
fs info                 # æ˜¾ç¤ºæ–‡ä»¶ç³»ç»Ÿä¿¡æ¯

# ç³»ç»Ÿä¿¡æ¯
help                    # æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
version                 # æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
```

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
Avatar/
â”œâ”€â”€ vmm/                    # VMM è™šæ‹ŸåŒ–ç®¡ç†ç¨‹åº
â”‚   â”œâ”€â”€ src/               # VMM æºä»£ç 
â”‚   â”œâ”€â”€ include/           # VMM å¤´æ–‡ä»¶
â”‚   â””â”€â”€ guest/             # Guest ç®¡ç†æ¨¡å—
â”œâ”€â”€ kernel/                # Avatar Kernel
â”‚   â”œâ”€â”€ src/               # å†…æ ¸æºä»£ç 
â”‚   â”œâ”€â”€ include/           # å†…æ ¸å¤´æ–‡ä»¶
â”‚   â”œâ”€â”€ mm/                # å†…å­˜ç®¡ç†
â”‚   â”œâ”€â”€ sched/             # è°ƒåº¦å™¨
â”‚   â”œâ”€â”€ fs/                # æ–‡ä»¶ç³»ç»Ÿ
â”‚   â””â”€â”€ drivers/           # è®¾å¤‡é©±åŠ¨
â”œâ”€â”€ guest/                 # Guest æ“ä½œç³»ç»Ÿ
â”‚   â”œâ”€â”€ linux/             # Linux Guest
â”‚   â”œâ”€â”€ nimbos/            # NimbOS Guest
â”‚   â”œâ”€â”€ testos/            # TestOS Guest
â”‚   â””â”€â”€ guest_manifests.c  # Guest é…ç½®æ–‡ä»¶
â”œâ”€â”€ scripts/               # æ„å»ºå’Œéƒ¨ç½²è„šæœ¬
â”‚   â”œâ”€â”€ create_host_img.sh # åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿé•œåƒ
â”‚   â””â”€â”€ setup_guest_files.sh # è®¾ç½® Guest æ–‡ä»¶
â”œâ”€â”€ app/                   # ç”¨æˆ·æ€åº”ç”¨ç¨‹åº
â””â”€â”€ tools/                 # å¼€å‘å·¥å…·
```

---

## ğŸ”§ é…ç½®è¯´æ˜

### Guest é…ç½®

Guest é…ç½®é€šè¿‡ `guest/guest_manifests.c` æ–‡ä»¶ç®¡ç†ï¼š

```c
// Guest é…ç½®ç¤ºä¾‹
static guest_manifest_t guest_manifests[] = {
    {
        .id = 0,
        .name = "Linux",
        .kernel_path = "/guests/linux/linux.bin",
        .dtb_path = "/guests/linux/linux.dtb",
        .initrd_path = "/guests/linux/initrd.gz",
        .load_addr = 0x60080000,
        .smp_cores = 1,
        .memory_size = 0x8000000,  // 128MB
    },
    // æ›´å¤š Guest é…ç½®...
};
```

### æ–‡ä»¶ç³»ç»Ÿç»“æ„

```
host.img:/
â””â”€â”€ guests/
    â”œâ”€â”€ linux/
    â”‚   â”œâ”€â”€ linux.bin      # Linux å†…æ ¸é•œåƒ
    â”‚   â”œâ”€â”€ linux.dtb      # è®¾å¤‡æ ‘æ–‡ä»¶
    â”‚   â””â”€â”€ initrd.gz      # åˆå§‹åŒ–æ–‡ä»¶ç³»ç»Ÿ
    â”œâ”€â”€ nimbos/
    â”‚   â””â”€â”€ nimbos.bin     # NimbOS å†…æ ¸é•œåƒ
    â””â”€â”€ testos/
        â””â”€â”€ testos.bin     # TestOS å†…æ ¸é•œåƒ
```

---

## ğŸ“– å¼€å‘æŒ‡å—

### æ·»åŠ æ–°çš„ Guest

1. **å‡†å¤‡ Guest é•œåƒ**: ç¼–è¯‘ç”Ÿæˆ Guest å†…æ ¸é•œåƒ
2. **æ›´æ–°é…ç½®**: åœ¨ `guest_manifests.c` ä¸­æ·»åŠ  Guest é…ç½®
3. **æ‹·è´æ–‡ä»¶**: ä½¿ç”¨è„šæœ¬å°†æ–‡ä»¶æ‹·è´åˆ° `host.img`
4. **æµ‹è¯•è¿è¡Œ**: ä½¿ç”¨ VMM å‘½ä»¤å¯åŠ¨å’Œæµ‹è¯• Guest

### æ‰©å±•å†…æ ¸åŠŸèƒ½

1. **æ·»åŠ ç³»ç»Ÿè°ƒç”¨**: åœ¨ `kernel/src/syscall/` ä¸­å®ç°æ–°çš„ç³»ç»Ÿè°ƒç”¨
2. **æ·»åŠ è®¾å¤‡é©±åŠ¨**: åœ¨ `kernel/drivers/` ä¸­å®ç°è®¾å¤‡é©±åŠ¨
3. **æ‰©å±•æ–‡ä»¶ç³»ç»Ÿ**: åœ¨ `kernel/fs/` ä¸­æ·»åŠ æ–°çš„æ–‡ä»¶ç³»ç»Ÿæ”¯æŒ

---

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ã€‚
